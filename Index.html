<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ropa y EPP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        .add-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .filter-section {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }

        .results-section {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
        }

        .section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .form-group select {
            color: white;
        }

        .form-group select option {
            background: #2c3e50;
            color: white;
            padding: 8px;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #2d3436;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .summary-card p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.8);
            font-size: 1.2rem;
        }

        .export-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Gestor de Ropa y EPP</h1>
            <p>Control de equipos de protecci√≥n personal y vestimenta por cargo</p>
        </div>

        <div class="content">
            <!-- Secci√≥n para agregar datos -->
            <div class="section add-section">
                <h2>‚ûï Agregar Nuevo Elemento</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cargo">Cargo:</label>
                        <input type="text" id="cargo" placeholder="Ej: Soldador, Operario, Supervisor">
                    </div>
                    <div class="form-group">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo">
                            <option value="">Seleccionar tipo</option>
                            <option value="Ropa">Ropa</option>
                            <option value="EPP">EPP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="elemento">Elemento:</label>
                        <input type="text" id="elemento" placeholder="Ej: Casco, Overol, Guantes">
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Cantidad:</label>
                        <input type="number" id="cantidad" min="1" placeholder="Cantidad necesaria">
                    </div>
                    <div class="form-group">
                        <label for="monto">Monto (por unidad):</label>
                        <input type="number" id="monto" min="0" step="0.01" placeholder="Precio unitario">
                    </div>
                    <div class="form-group">
                        <label for="proveedor">Proveedor:</label>
                        <input type="text" id="proveedor" placeholder="Nombre del proveedor">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="agregarElemento()">Agregar Elemento</button>
            </div>

            <!-- Secci√≥n de filtros -->
            <div class="section filter-section">
                <h2>üîç Filtros Avanzados</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="filtro-cargo">Cargo:</label>
                        <select id="filtro-cargo" onchange="aplicarFiltros()">
                            <option value="">Todos los cargos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtro-proveedor">Proveedor:</label>
                        <select id="filtro-proveedor" onchange="aplicarFiltros()">
                            <option value="">Todos los proveedores</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtro-tipo">Tipo:</label>
                        <select id="filtro-tipo" onchange="aplicarFiltros()">
                            <option value="">Todos los tipos</option>
                            <option value="Ropa">Ropa</option>
                            <option value="EPP">EPP</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
                </div>
            </div>

            <!-- Secci√≥n de resultados -->
            <div class="section results-section">
                <h2>üìä Resultados</h2>
                <div class="export-controls">
                    <input type="file" id="cargar-archivo" accept=".csv" style="display: none;">
                    <button class="btn btn-secondary" onclick="document.getElementById('cargar-archivo').click()">üìÅ Cargar CSV</button>
                    <button class="btn btn-secondary" onclick="descargarPlantilla()">üìã Descargar Plantilla</button>
                    <button class="btn btn-primary" onclick="exportarCSV()">üìä Exportar CSV</button>
                </div>
                <div id="resumen" class="summary-cards"></div>
                <div id="tabla-container">
                    <table class="data-table" id="tabla-datos">
                        <thead>
                            <tr>
                                <th>Cargo</th>
                                <th>Tipo</th>
                                <th>Elemento</th>
                                <th>Cantidad</th>
                                <th>Monto Unit.</th>
                                <th>Total</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let datos = [];
        let filtros = {
            cargo: '',
            proveedor: '',
            tipo: ''
        };

        function agregarElemento() {
            const cargo = document.getElementById('cargo').value.trim();
            const tipo = document.getElementById('tipo').value;
            const elemento = document.getElementById('elemento').value.trim();
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const monto = parseFloat(document.getElementById('monto').value);
            const proveedor = document.getElementById('proveedor').value.trim();

            if (!cargo || !tipo || !elemento || !cantidad || !monto || !proveedor) {
                alert('Por favor complete todos los campos');
                return;
            }

            const nuevoElemento = {
                id: Date.now() + Math.random(),
                cargo: cargo,
                tipo: tipo,
                elemento: elemento,
                cantidad: cantidad,
                monto: monto,
                proveedor: proveedor,
                total: cantidad * monto
            };

            datos.push(nuevoElemento);
            actualizarFiltros();
            mostrarDatos();
            limpiarFormulario();
        }

        function limpiarFormulario() {
            document.getElementById('cargo').value = '';
            document.getElementById('tipo').value = '';
            document.getElementById('elemento').value = '';
            document.getElementById('cantidad').value = '';
            document.getElementById('monto').value = '';
            document.getElementById('proveedor').value = '';
        }

        function actualizarFiltros() {
            actualizarFiltroCargos();
            actualizarFiltroProveedores();
        }

        function actualizarFiltroCargos() {
            const selectCargo = document.getElementById('filtro-cargo');
            const cargosUnicos = [...new Set(datos.map(item => item.cargo))];
            
            selectCargo.innerHTML = '<option value="">Todos los cargos</option>';
            cargosUnicos.forEach(cargo => {
                const option = document.createElement('option');
                option.value = cargo;
                option.textContent = cargo;
                selectCargo.appendChild(option);
            });
        }

        function actualizarFiltroProveedores() {
            const selectProveedor = document.getElementById('filtro-proveedor');
            const proveedoresUnicos = [...new Set(datos.map(item => item.proveedor))];
            
            selectProveedor.innerHTML = '<option value="">Todos los proveedores</option>';
            proveedoresUnicos.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor;
                option.textContent = proveedor;
                selectProveedor.appendChild(option);
            });
        }

        function aplicarFiltros() {
            filtros.cargo = document.getElementById('filtro-cargo').value;
            filtros.proveedor = document.getElementById('filtro-proveedor').value;
            filtros.tipo = document.getElementById('filtro-tipo').value;
            mostrarDatos();
        }

        function limpiarFiltros() {
            document.getElementById('filtro-cargo').value = '';
            document.getElementById('filtro-proveedor').value = '';
            document.getElementById('filtro-tipo').value = '';
            filtros = { cargo: '', proveedor: '', tipo: '' };
            mostrarDatos();
        }

        function obtenerDatosFiltrados() {
            return datos.filter(item => {
                return (!filtros.cargo || item.cargo === filtros.cargo) &&
                       (!filtros.proveedor || item.proveedor === filtros.proveedor) &&
                       (!filtros.tipo || item.tipo === filtros.tipo);
            });
        }

        function mostrarDatos() {
            const datosFiltrados = obtenerDatosFiltrados();
            mostrarTabla(datosFiltrados);
            mostrarResumen(datosFiltrados);
        }

        function mostrarTabla(datosFiltrados) {
            const tbody = document.getElementById('tabla-body');
            
            if (datosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No hay datos para mostrar</td></tr>';
                return;
            }

            let html = '';
            for (let i = 0; i < datosFiltrados.length; i++) {
                const item = datosFiltrados[i];
                html += `
                    <tr>
                        <td><strong>${item.cargo}</strong></td>
                        <td><span style="background: ${item.tipo === 'EPP' ? '#e74c3c' : '#3498db'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">${item.tipo}</span></td>
                        <td>${item.elemento}</td>
                        <td><strong>${item.cantidad}</strong></td>
                        <td>$${Math.round(item.monto)}</td>
                        <td><strong>$${Math.round(item.total)}</strong></td>
                        <td>${item.proveedor}</td>
                        <td>
                            <button class="delete-btn" onclick="eliminar(${i})" type="button">
                                ‚ùå Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }

        function eliminar(indice) {
            const datosFiltrados = obtenerDatosFiltrados();
            const elemento = datosFiltrados[indice];

            for (let i = 0; i < datos.length; i++) {
                if (datos[i].id === elemento.id) {
                    datos.splice(i, 1);
                    break;
                }
            }

            actualizarFiltros();
            mostrarDatos();
        }

        function mostrarResumen(datosFiltrados) {
            const resumenDiv = document.getElementById('resumen');
            
            if (datosFiltrados.length === 0) {
                resumenDiv.innerHTML = '';
                return;
            }

            const totalRopa = datosFiltrados
                .filter(item => item.tipo === 'Ropa')
                .reduce((sum, item) => sum + item.cantidad, 0);

            const totalEPP = datosFiltrados
                .filter(item => item.tipo === 'EPP')
                .reduce((sum, item) => sum + item.cantidad, 0);

            const montoTotalRopa = datosFiltrados
                .filter(item => item.tipo === 'Ropa')
                .reduce((sum, item) => sum + item.total, 0);

            const montoTotalEPP = datosFiltrados
                .filter(item => item.tipo === 'EPP')
                .reduce((sum, item) => sum + item.total, 0);

            const montoTotal = montoTotalRopa + montoTotalEPP;
            const proveedoresUnicos = [...new Set(datosFiltrados.map(item => item.proveedor))];

            resumenDiv.innerHTML = `
                <div class="summary-card">
                    <h3>${totalRopa}</h3>
                    <p>Piezas de Ropa</p>
                </div>
                <div class="summary-card">
                    <h3>${totalEPP}</h3>
                    <p>Elementos EPP</p>
                </div>
                <div class="summary-card">
                    <h3>$${Math.round(montoTotalRopa)}</h3>
                    <p>Costo Ropa</p>
                </div>
                <div class="summary-card">
                    <h3>$${Math.round(montoTotalEPP)}</h3>
                    <p>Costo EPP</p>
                </div>
                <div class="summary-card">
                    <h3>$${Math.round(montoTotal)}</h3>
                    <p>Costo Total</p>
                </div>
                <div class="summary-card">
                    <h3>${proveedoresUnicos.length}</h3>
                    <p>Proveedores</p>
                </div>
            `;
        }

        function exportarCSV() {
            const datosFiltrados = obtenerDatosFiltrados();
            if (datosFiltrados.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            try {
                const headers = ['Cargo', 'Tipo', 'Elemento', 'Cantidad', 'Monto Unitario', 'Total', 'Proveedor'];
                const csvRows = [headers.join(',')];
                
                datosFiltrados.forEach(item => {
                    const row = [
                        `"${item.cargo.replace(/"/g, '""')}"`,
                        `"${item.tipo}"`,
                        `"${item.elemento.replace(/"/g, '""')}"`,
                        item.cantidad,
                        Math.round(item.monto),
                        Math.round(item.total),
                        `"${item.proveedor.replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const fecha = new Date().toISOString().split('T')[0];
                
                const blob = new Blob(['\ufeff' + csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.style.display = 'none';
                link.href = url;
                link.download = `reporte_epp_${fecha}.csv`;
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                alert('‚úÖ Archivo CSV descargado exitosamente');
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('‚ùå Error al exportar. Intenta nuevamente.');
            }
        }

        function procesarCSV(contenido) {
            try {
                const lineas = contenido.split('\n');
                if (lineas.length < 2) {
                    alert('‚ùå El archivo CSV est√° vac√≠o');
                    return;
                }

                const primeraLinea = lineas[0];
                const separador = primeraLinea.includes(';') ? ';' : ',';
                console.log('Separador detectado:', separador);

                const headers = primeraLinea.split(separador).map(h => h.replace(/"/g, '').trim().toLowerCase());
                console.log('Headers encontrados:', headers);

                const mapeoHeaders = {
                    'cargo': ['cargo', 'puesto', 'position', 'job', 'trabajo'],
                    'tipo': ['tipo', 'type', 'categoria', 'category', 'clase'],
                    'elemento': ['elemento', 'item', 'articulo', 'product', 'producto', 'descripcion'],
                    'cantidad': ['cantidad', 'qty', 'quantity', 'cant', 'unidades'],
                    'monto': ['monto', 'precio', 'price', 'costo', 'cost', 'valor', 'monto unitario', 'unitario'],
                    'proveedor': ['proveedor', 'supplier', 'vendor', 'empresa', 'fabricante']
                };

                const indices = {};
                Object.keys(mapeoHeaders).forEach(campo => {
                    // Buscar coincidencia exacta primero
                    let index = headers.findIndex(h => h === campo);
                    
                    // Si no encuentra coincidencia exacta, buscar que contenga alguna variante
                    if (index === -1) {
                        index = headers.findIndex(h => 
                            mapeoHeaders[campo].some(variante => h.includes(variante) || variante.includes(h))
                        );
                    }
                    
                    if (index !== -1) {
                        indices[campo] = index;
                        console.log(`Campo '${campo}' encontrado en columna ${index}: '${headers[index]}'`);
                    }
                });

                console.log('√çndices mapeados:', indices);

                // Verificar que tenemos los campos m√≠nimos
                if (indices.cargo === undefined || indices.tipo === undefined || indices.elemento === undefined) {
                    const faltantes = [];
                    if (indices.cargo === undefined) faltantes.push('Cargo');
                    if (indices.tipo === undefined) faltantes.push('Tipo');
                    if (indices.elemento === undefined) faltantes.push('Elemento');
                    
                    alert(`‚ùå No se encontraron las columnas requeridas: ${faltantes.join(', ')}\n\nColumnas encontradas: ${headers.join(', ')}\n\nVerifica que el archivo tenga las columnas: Cargo, Tipo, Elemento`);
                    return;
                }

                let datosImportados = 0;
                let errores = 0;

                for (let i = 1; i < lineas.length; i++) {
                    const linea = lineas[i].trim();
                    if (!linea) continue;

                    let valores;
                    if (separador === ';') {
                        valores = linea.split(';').map(v => v.trim().replace(/^"|"$/g, ''));
                    } else {
                        // Para comas, manejo m√°s complejo respetando comillas
                        valores = [];
                        let dentroComillas = false;
                        let valorActual = '';
                        
                        for (let j = 0; j < linea.length; j++) {
                            const char = linea[j];
                            if (char === '"') {
                                dentroComillas = !dentroComillas;
                            } else if (char === ',' && !dentroComillas) {
                                valores.push(valorActual.trim().replace(/^"|"$/g, ''));
                                valorActual = '';
                            } else {
                                valorActual += char;
                            }
                        }
                        valores.push(valorActual.trim().replace(/^"|"$/g, ''));
                    }

                    const cargo = (valores[indices.cargo] || '').toString().trim();
                    const tipo = (valores[indices.tipo] || '').toString().trim();
                    const elemento = (valores[indices.elemento] || '').toString().trim();
                    const cantidad = parseInt(valores[indices.cantidad]) || 1;
                    const monto = parseFloat(valores[indices.monto]) || 0;
                    const proveedor = (valores[indices.proveedor] || 'Sin especificar').toString().trim();

                    console.log(`Fila ${i}: cargo='${cargo}', tipo='${tipo}', elemento='${elemento}'`);

                    if (cargo && tipo && elemento) {
                        const nuevoElemento = {
                            id: Date.now() + i + Math.random() * 1000,
                            cargo: cargo,
                            tipo: tipo,
                            elemento: elemento,
                            cantidad: cantidad,
                            monto: monto,
                            proveedor: proveedor,
                            total: cantidad * monto
                        };
                        datos.push(nuevoElemento);
                        datosImportados++;
                    } else {
                        errores++;
                        console.log(`Fila ${i} omitida por datos incompletos`);
                    }
                }

                actualizarFiltros();
                mostrarDatos();
                
                let mensaje = `‚úÖ Se importaron ${datosImportados} elementos exitosamente`;
                if (errores > 0) {
                    mensaje += `\n‚ö†Ô∏è ${errores} filas omitidas por datos incompletos`;
                }
                alert(mensaje);

            } catch (error) {
                console.error('Error al procesar CSV:', error);
                alert('‚ùå Error al procesar el archivo CSV. Verifica el formato.');
            }
        }

        function descargarPlantilla() {
            const plantilla = [
                'Cargo,Tipo,Elemento,Cantidad,Monto Unitario,Proveedor',
                'Soldador,EPP,Casco de seguridad,2,45500,Seguridad Industrial SA',
                'Soldador,Ropa,Overol ign√≠fugo,1,85000,Textiles Industriales',
                'Operario,EPP,Guantes de seguridad,5,12300,Protecci√≥n Total',
                'Supervisor,Ropa,Chaleco reflectivo,1,25000,Uniformes Pro'
            ].join('\n');

            const blob = new Blob(['\ufeff' + plantilla], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.style.display = 'none';
            link.href = url;
            link.download = 'plantilla_epp.csv';
            
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        // Event listener para carga de archivos
        document.addEventListener('DOMContentLoaded', function() {
            mostrarDatos();
            
            document.getElementById('cargar-archivo').addEventListener('change', function(event) {
                const archivo = event.target.files[0];
                if (!archivo) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    procesarCSV(e.target.result);
                };
                reader.readAsText(archivo, 'UTF-8');
                event.target.value = '';
            });
        });
    </script>
</body>
</html>
