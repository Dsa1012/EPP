<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ropa y EPP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        .add-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .filter-section {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }

        .results-section {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
        }

        .section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #2d3436;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .summary-card p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.8);
            font-size: 1.2rem;
        }

        .export-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Gestor de Ropa y EPP</h1>
            <p>Control de equipos de protecci√≥n personal y vestimenta por cargo</p>
        </div>

        <div class="content">
            <!-- Secci√≥n para agregar datos -->
            <div class="section add-section">
                <h2>‚ûï Agregar Nuevo Elemento</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cargo">Cargo:</label>
                        <input type="text" id="cargo" placeholder="Ej: Soldador, Operario, Supervisor">
                    </div>
                    <div class="form-group">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo">
                            <option value="">Seleccionar tipo</option>
                            <option value="Ropa">Ropa</option>
                            <option value="EPP">EPP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="elemento">Elemento:</label>
                        <input type="text" id="elemento" placeholder="Ej: Casco, Overol, Guantes">
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Cantidad:</label>
                        <input type="number" id="cantidad" min="1" placeholder="Cantidad necesaria">
                    </div>
                    <div class="form-group">
                        <label for="monto">Monto (por unidad):</label>
                        <input type="number" id="monto" min="0" step="0.01" placeholder="Precio unitario">
                    </div>
                    <div class="form-group">
                        <label for="proveedor">Proveedor:</label>
                        <input type="text" id="proveedor" placeholder="Nombre del proveedor">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="agregarElemento()">Agregar Elemento</button>
            </div>

            <!-- Secci√≥n de filtros -->
            <div class="section filter-section">
                <h2>üîç Filtros Avanzados</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="filtro-cargo">Cargo:</label>
                        <select id="filtro-cargo" onchange="aplicarFiltros()">
                            <option value="">Todos los cargos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtro-proveedor">Proveedor:</label>
                        <select id="filtro-proveedor" onchange="aplicarFiltros()">
                            <option value="">Todos los proveedores</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtro-tipo">Tipo:</label>
                        <select id="filtro-tipo" onchange="aplicarFiltros()">
                            <option value="">Todos los tipos</option>
                            <option value="Ropa">Ropa</option>
                            <option value="EPP">EPP</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
                </div>
            </div>

            <!-- Secci√≥n de resultados -->
            <div class="section results-section">
                <h2>üìä Resultados</h2>
                <div class="export-controls">
                    <input type="file" id="cargar-archivo" accept=".csv,.xlsx,.xls,.json" style="display: none;" onchange="cargarArchivo(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('cargar-archivo').click()">üìÅ Cargar Datos</button>
                    <button class="btn btn-secondary" onclick="descargarPlantilla()">üìã Descargar Plantilla</button>
                    <button class="btn btn-primary" onclick="exportarExcel()">üìä Exportar a Excel</button>
                    <button class="btn btn-primary" onclick="exportarPDF()">üìÑ Exportar a PDF</button>
                    <button class="btn btn-secondary" onclick="imprimirReporte()">üñ®Ô∏è Imprimir</button>
                </div>
                <div id="resumen" class="summary-cards"></div>
                <div id="tabla-container">
                    <table class="data-table" id="tabla-datos">
                        <thead>
                            <tr>
                                <th>Cargo</th>
                                <th>Tipo</th>
                                <th>Elemento</th>
                                <th>Cantidad</th>
                                <th>Monto Unit.</th>
                                <th>Total</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let datos = [];
        let filtros = {
            cargo: '',
            proveedor: '',
            tipo: ''
        };

        function agregarElemento() {
            const cargo = document.getElementById('cargo').value.trim();
            const tipo = document.getElementById('tipo').value;
            const elemento = document.getElementById('elemento').value.trim();
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const monto = parseFloat(document.getElementById('monto').value);
            const proveedor = document.getElementById('proveedor').value.trim();

            if (!cargo || !tipo || !elemento || !cantidad || !monto || !proveedor) {
                alert('Por favor complete todos los campos');
                return;
            }

            const nuevoElemento = {
                id: Date.now(),
                cargo: cargo,
                tipo: tipo,
                elemento: elemento,
                cantidad: cantidad,
                monto: monto,
                proveedor: proveedor,
                total: cantidad * monto
            };

            datos.push(nuevoElemento);
            actualizarFiltros();
            mostrarDatos();
            limpiarFormulario();
        }

        function limpiarFormulario() {
            document.getElementById('cargo').value = '';
            document.getElementById('tipo').value = '';
            document.getElementById('elemento').value = '';
            document.getElementById('cantidad').value = '';
            document.getElementById('monto').value = '';
            document.getElementById('proveedor').value = '';
        }

        function actualizarFiltros() {
            actualizarFiltroCargos();
            actualizarFiltroProveedores();
        }

        function actualizarFiltroCargos() {
            const selectCargo = document.getElementById('filtro-cargo');
            const cargosUnicos = [...new Set(datos.map(item => item.cargo))];
            
            selectCargo.innerHTML = '<option value="">Todos los cargos</option>';
            cargosUnicos.forEach(cargo => {
                const option = document.createElement('option');
                option.value = cargo;
                option.textContent = cargo;
                selectCargo.appendChild(option);
            });
        }

        function actualizarFiltroProveedores() {
            const selectProveedor = document.getElementById('filtro-proveedor');
            const proveedoresUnicos = [...new Set(datos.map(item => item.proveedor))];
            
            selectProveedor.innerHTML = '<option value="">Todos los proveedores</option>';
            proveedoresUnicos.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor;
                option.textContent = proveedor;
                selectProveedor.appendChild(option);
            });
        }

        function aplicarFiltros() {
            filtros.cargo = document.getElementById('filtro-cargo').value;
            filtros.proveedor = document.getElementById('filtro-proveedor').value;
            filtros.tipo = document.getElementById('filtro-tipo').value;
            mostrarDatos();
        }

        function limpiarFiltros() {
            document.getElementById('filtro-cargo').value = '';
            document.getElementById('filtro-proveedor').value = '';
            document.getElementById('filtro-tipo').value = '';
            filtros = { cargo: '', proveedor: '', tipo: '' };
            mostrarDatos();
        }

        function eliminarElemento(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este elemento?')) {
                datos = datos.filter(item => item.id !== id);
                actualizarFiltros();
                mostrarDatos();
            }
        }

        function obtenerDatosFiltrados() {
            return datos.filter(item => {
                return (!filtros.cargo || item.cargo === filtros.cargo) &&
                       (!filtros.proveedor || item.proveedor === filtros.proveedor) &&
                       (!filtros.tipo || item.tipo === filtros.tipo);
            });
        }

        function mostrarDatos() {
            const datosFiltrados = obtenerDatosFiltrados();
            mostrarTabla(datosFiltrados);
            mostrarResumen(datosFiltrados);
        }

        function mostrarTabla(datosFiltrados) {
            const tbody = document.getElementById('tabla-body');
            
            if (datosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No hay datos para mostrar</td></tr>';
                return;
            }

            tbody.innerHTML = datosFiltrados.map(item => `
                <tr>
                    <td><strong>${item.cargo}</strong></td>
                    <td><span style="background: ${item.tipo === 'EPP' ? '#e74c3c' : '#3498db'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">${item.tipo}</span></td>
                    <td>${item.elemento}</td>
                    <td><strong>${item.cantidad}</strong></td>
                    <td>$${item.monto.toFixed(2)}</td>
                    <td><strong>$${item.total.toFixed(2)}</strong></td>
                    <td>${item.proveedor}</td>
                    <td><button class="delete-btn" onclick="eliminarElemento(${item.id})">Eliminar</button></td>
                </tr>
            `).join('');
        }

        function mostrarResumen(datosFiltrados) {
            const resumenDiv = document.getElementById('resumen');
            
            if (datosFiltrados.length === 0) {
                resumenDiv.innerHTML = '';
                return;
            }

            const totalRopa = datosFiltrados
                .filter(item => item.tipo === 'Ropa')
                .reduce((sum, item) => sum + item.cantidad, 0);

            const totalEPP = datosFiltrados
                .filter(item => item.tipo === 'EPP')
                .reduce((sum, item) => sum + item.cantidad, 0);

            const montoTotalRopa = datosFiltrados
                .filter(item => item.tipo === 'Ropa')
                .reduce((sum, item) => sum + item.total, 0);

            const montoTotalEPP = datosFiltrados
                .filter(item => item.tipo === 'EPP')
                .reduce((sum, item) => sum + item.total, 0);

            const montoTotal = montoTotalRopa + montoTotalEPP;
            const proveedoresUnicos = [...new Set(datosFiltrados.map(item => item.proveedor))];

            resumenDiv.innerHTML = `
                <div class="summary-card">
                    <h3>${totalRopa}</h3>
                    <p>Piezas de Ropa</p>
                </div>
                <div class="summary-card">
                    <h3>${totalEPP}</h3>
                    <p>Elementos EPP</p>
                </div>
                <div class="summary-card">
                    <h3>$${montoTotalRopa.toFixed(2)}</h3>
                    <p>Costo Ropa</p>
                </div>
                <div class="summary-card">
                    <h3>$${montoTotalEPP.toFixed(2)}</h3>
                    <p>Costo EPP</p>
                </div>
                <div class="summary-card">
                    <h3>$${montoTotal.toFixed(2)}</h3>
                    <p>Costo Total</p>
                </div>
                <div class="summary-card">
                    <h3>${proveedoresUnicos.length}</h3>
                    <p>Proveedores</p>
                </div>
            `;
        }

        function exportarExcel() {
            const datosFiltrados = obtenerDatosFiltrados();
            if (datosFiltrados.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            try {
                // Crear datos para Excel
                const headers = ['Cargo', 'Tipo', 'Elemento', 'Cantidad', 'Monto Unitario', 'Total', 'Proveedor'];
                const datos_excel = [headers];
                
                datosFiltrados.forEach(item => {
                    datos_excel.push([
                        item.cargo,
                        item.tipo,
                        item.elemento,
                        item.cantidad,
                        item.monto,
                        item.total,
                        item.proveedor
                    ]);
                });

                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(datos_excel);

                // Aplicar formato
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                // Estilo para headers
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: 0, c: col});
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2C3E50" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // Cargo
                    { wch: 8 },  // Tipo
                    { wch: 25 }, // Elemento
                    { wch: 10 }, // Cantidad
                    { wch: 12 }, // Monto Unit.
                    { wch: 12 }, // Total
                    { wch: 20 }  // Proveedor
                ];
                ws['!cols'] = colWidths;

                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, "Reporte EPP");

                // Generar archivo y descargar
                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `reporte_epp_${fecha}.xlsx`);
                
                alert('‚úÖ Archivo Excel descargado exitosamente');
                
            } catch (error) {
                console.error('Error al exportar Excel:', error);
                alert('‚ùå Error al exportar. Descargando como CSV...');
                // Fallback a CSV si falla Excel
                exportarCSV();
            }
        }

        function exportarCSV() {
            const datosFiltrados = obtenerDatosFiltrados();
            const headers = ['Cargo', 'Tipo', 'Elemento', 'Cantidad', 'Monto Unitario', 'Total', 'Proveedor'];
            const csvRows = [headers.join(',')];
            
            datosFiltrados.forEach(item => {
                const row = [
                    `"${item.cargo.replace(/"/g, '""')}"`,
                    `"${item.tipo}"`,
                    `"${item.elemento.replace(/"/g, '""')}"`,
                    item.cantidad,
                    item.monto.toFixed(2),
                    item.total.toFixed(2),
                    `"${item.proveedor.replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');
            const fecha = new Date().toISOString().split('T')[0];
            
            const blob = new Blob(['\ufeff' + csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.style.display = 'none';
            link.href = url;
            link.download = `reporte_epp_${fecha}.csv`;
            
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        function exportarPDF() {
            const datosFiltrados = obtenerDatosFiltrados();
            if (datosFiltrados.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            try {
                const fecha = new Date().toLocaleDateString('es-ES');
                
                let filtrosAplicados = [];
                if (filtros.cargo) filtrosAplicados.push(`Cargo: ${filtros.cargo}`);
                if (filtros.proveedor) filtrosAplicados.push(`Proveedor: ${filtros.proveedor}`);
                if (filtros.tipo) filtrosAplicados.push(`Tipo: ${filtros.tipo}`);
                
                const filtrosTexto = filtrosAplicados.length > 0 ? 
                    `<p><strong>Filtros aplicados:</strong> ${filtrosAplicados.join(', ')}</p>` : 
                    '<p><strong>Mostrando:</strong> Todos los datos</p>';

                const totalRopa = datosFiltrados.filter(i => i.tipo === 'Ropa').reduce((s, i) => s + i.cantidad, 0);
                const totalEPP = datosFiltrados.filter(i => i.tipo === 'EPP').reduce((s, i) => s + i.cantidad, 0);
                const costoTotal = datosFiltrados.reduce((s, i) => s + i.total, 0);

                const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte EPP - ${fecha}</title>
                    <style>
                        @page { margin: 1in; }
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px;
                            font-size: 12px;
                        }
                        h1 { 
                            color: #2c3e50; 
                            text-align: center; 
                            margin-bottom: 10px;
                            font-size: 24px;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 2px solid #2c3e50;
                            padding-bottom: 15px;
                        }
                        .summary { 
                            display: flex; 
                            justify-content: space-around; 
                            margin: 20px 0;
                            background-color: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                        }
                        .summary-item { 
                            text-align: center; 
                            padding: 10px; 
                            border: 1px solid #ddd; 
                            border-radius: 5px;
                            background-color: white;
                            min-width: 120px;
                        }
                        .summary-item h3 {
                            margin: 0 0 5px 0;
                            color: #2c3e50;
                            font-size: 18px;
                        }
                        .summary-item p {
                            margin: 0;
                            color: #666;
                            font-size: 11px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                            font-size: 11px;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        th { 
                            background-color: #2c3e50; 
                            color: white;
                            font-weight: bold; 
                        }
                        tr:nth-child(even) { 
                            background-color: #f9f9f9; 
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                            border-top: 1px solid #ddd;
                            padding-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üõ°Ô∏è Reporte de Ropa y EPP</h1>
                        <p><strong>Fecha de generaci√≥n:</strong> ${fecha}</p>
                        ${filtrosTexto}
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <h3>${totalRopa}</h3>
                            <p>Piezas de Ropa</p>
                        </div>
                        <div class="summary-item">
                            <h3>${totalEPP}</h3>
                            <p>Elementos EPP</p>
                        </div>
                        <div class="summary-item">
                            <h3>$${costoTotal.toFixed(2)}</h3>
                            <p>Costo Total</p>
                        </div>
                        <div class="summary-item">
                            <h3>${datosFiltrados.length}</h3>
                            <p>Total Elementos</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Cargo</th>
                                <th>Tipo</th>
                                <th>Elemento</th>
                                <th>Cantidad</th>
                                <th>Monto Unit.</th>
                                <th>Total</th>
                                <th>Proveedor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${datosFiltrados.map(item => `
                                <tr>
                                    <td>${item.cargo}</td>
                                    <td>${item.tipo}</td>
                                    <td>${item.elemento}</td>
                                    <td>${item.cantidad}</td>
                                    <td>$${item.monto.toFixed(2)}</td>
                                    <td><strong>$${item.total.toFixed(2)}</strong></td>
                                    <td>${item.proveedor}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Generado por Sistema de Gesti√≥n EPP - ${new Date().toLocaleString('es-ES')}</p>
                    </div>
                </body>
                </html>`;

                const ventanaImpresion = window.open('', '_blank');
                if (ventanaImpresion) {
                    ventanaImpresion.document.write(htmlContent);
                    ventanaImpresion.document.close();
                    
                    setTimeout(() => {
                        ventanaImpresion.focus();
                        ventanaImpresion.print();
                    }, 500);
                } else {
                    alert('‚ùå No se pudo abrir la ventana de impresi√≥n. Verifica que no est√© bloqueada por el navegador.');
                }
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('‚ùå Error al generar el reporte. Intenta nuevamente.');
            }
        }

        function imprimirReporte() {
            const datosFiltrados = obtenerDatosFiltrados();
            if (datosFiltrados.length === 0) {
                alert('No hay datos para imprimir');
                return;
            }
            exportarPDF();
        }

        // Funci√≥n para cargar archivos
        function cargarArchivo(event) {
            const archivo = event.target.files[0];
            if (!archivo) return;

            const extension = archivo.name.toLowerCase().split('.').pop();
            const reader = new FileReader();

            if (extension === 'csv') {
                reader.onload = function(e) {
                    procesarCSV(e.target.result);
                };
                reader.readAsText(archivo);
            } else if (extension === 'json') {
                reader.onload = function(e) {
                    procesarJSON(e.target.result);
                };
                reader.readAsText(archivo);
            } else if (extension === 'xlsx' || extension === 'xls') {
                reader.onload = function(e) {
                    procesarExcel(e.target.result);
                };
                reader.readAsArrayBuffer(archivo);
            } else {
                alert('‚ùå Formato de archivo no soportado. Use CSV, JSON, XLS o XLSX');
            }
        }

        function procesarCSV(contenido) {
            try {
                const lineas = contenido.split('\n');
                const headers = lineas[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
                
                // Mapear headers comunes
                const mapeoHeaders = {
                    'cargo': ['cargo', 'puesto', 'position', 'job'],
                    'tipo': ['tipo', 'type', 'categoria', 'category'],
                    'elemento': ['elemento', 'item', 'articulo', 'product', 'producto'],
                    'cantidad': ['cantidad', 'qty', 'quantity', 'cant'],
                    'monto': ['monto', 'precio', 'price', 'costo', 'cost', 'valor'],
                    'proveedor': ['proveedor', 'supplier', 'vendor', 'empresa']
                };

                const indices = {};
                Object.keys(mapeoHeaders).forEach(campo => {
                    const index = headers.findIndex(h => 
                        mapeoHeaders[campo].some(variante => h.includes(variante))
                    );
                    if (index !== -1) indices[campo] = index;
                });

                // Verificar que tenemos los campos m√≠nimos
                if (!indices.cargo || !indices.tipo || !indices.elemento) {
                    alert('‚ùå El archivo CSV debe contener al menos las columnas: Cargo, Tipo, Elemento');
                    return;
                }

                let datosImportados = 0;
                for (let i = 1; i < lineas.length; i++) {
                    const linea = lineas[i].trim();
                    if (!linea) continue;

                    const valores = linea.split(',').map(v => v.replace(/"/g, '').trim());
                    
                    const cargo = valores[indices.cargo];
                    const tipo = valores[indices.tipo];
                    const elemento = valores[indices.elemento];
                    const cantidad = parseInt(valores[indices.cantidad]) || 1;
                    const monto = parseFloat(valores[indices.monto]) || 0;
                    const proveedor = valores[indices.proveedor] || 'Sin especificar';

                    if (cargo && tipo && elemento) {
                        const nuevoElemento = {
                            id: Date.now() + i,
                            cargo: cargo,
                            tipo: tipo,
                            elemento: elemento,
                            cantidad: cantidad,
                            monto: monto,
                            proveedor: proveedor,
                            total: cantidad * monto
                        };
                        datos.push(nuevoElemento);
                        datosImportados++;
                    }
                }

                actualizarFiltros();
                mostrarDatos();
                alert(`‚úÖ Se importaron ${datosImportados} elementos exitosamente`);

            } catch (error) {
                console.error('Error al procesar CSV:', error);
                alert('‚ùå Error al procesar el archivo CSV. Verifica el formato.');
            }
        }

        function procesarJSON(contenido) {
            try {
                const datosJSON = JSON.parse(contenido);
                let datosImportados = 0;

                // Verificar si es un array
                const array = Array.isArray(datosJSON) ? datosJSON : [datosJSON];

                array.forEach((item, index) => {
                    // Mapear propiedades comunes
                    const cargo = item.cargo || item.puesto || item.position || item.job;
                    const tipo = item.tipo || item.type || item.categoria || item.category;
                    const elemento = item.elemento || item.item || item.articulo || item.product;
                    const cantidad = parseInt(item.cantidad || item.qty || item.quantity) || 1;
                    const monto = parseFloat(item.monto || item.precio || item.price || item.costo) || 0;
                    const proveedor = item.proveedor || item.supplier || item.vendor || 'Sin especificar';

                    if (cargo && tipo && elemento) {
                        const nuevoElemento = {
                            id: Date.now() + index,
                            cargo: cargo,
                            tipo: tipo,
                            elemento: elemento,
                            cantidad: cantidad,
                            monto: monto,
                            proveedor: proveedor,
                            total: cantidad * monto
                        };
                        datos.push(nuevoElemento);
                        datosImportados++;
                    }
                });

                actualizarFiltros();
                mostrarDatos();
                alert(`‚úÖ Se importaron ${datosImportados} elementos exitosamente`);

            } catch (error) {
                console.error('Error al procesar JSON:', error);
                alert('‚ùå Error al procesar el archivo JSON. Verifica el formato.');
            }
        }

        function procesarExcel(contenido) {
            try {
                // Leer el archivo Excel
                const workbook = XLSX.read(contenido, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Convertir a JSON
                const datosJSON = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (datosJSON.length < 2) {
                    alert('‚ùå El archivo Excel est√° vac√≠o o no tiene datos v√°lidos');
                    return;
                }

                const headers = datosJSON[0].map(h => (h || '').toString().toLowerCase().trim());
                
                // Mapear headers comunes
                const mapeoHeaders = {
                    'cargo': ['cargo', 'puesto', 'position', 'job'],
                    'tipo': ['tipo', 'type', 'categoria', 'category'],
                    'elemento': ['elemento', 'item', 'articulo', 'product', 'producto'],
                    'cantidad': ['cantidad', 'qty', 'quantity', 'cant'],
                    'monto': ['monto', 'precio', 'price', 'costo', 'cost', 'valor', 'monto unitario'],
                    'proveedor': ['proveedor', 'supplier', 'vendor', 'empresa']
                };

                const indices = {};
                Object.keys(mapeoHeaders).forEach(campo => {
                    const index = headers.findIndex(h => 
                        mapeoHeaders[campo].some(variante => h.includes(variante))
                    );
                    if (index !== -1) indices[campo] = index;
                });

                // Verificar que tenemos los campos m√≠nimos
                if (!indices.cargo || !indices.tipo || !indices.elemento) {
                    alert('‚ùå El archivo Excel debe contener al menos las columnas: Cargo, Tipo, Elemento');
                    return;
                }

                let datosImportados = 0;
                for (let i = 1; i < datosJSON.length; i++) {
                    const fila = datosJSON[i];
                    if (!fila || fila.length === 0) continue;

                    const cargo = (fila[indices.cargo] || '').toString().trim();
                    const tipo = (fila[indices.tipo] || '').toString().trim();
                    const elemento = (fila[indices.elemento] || '').toString().trim();
                    const cantidad = parseInt(fila[indices.cantidad]) || 1;
                    const monto = parseFloat(fila[indices.monto]) || 0;
                    const proveedor = (fila[indices.proveedor] || 'Sin especificar').toString().trim();

                    if (cargo && tipo && elemento) {
                        const nuevoElemento = {
                            id: Date.now() + i,
                            cargo: cargo,
                            tipo: tipo,
                            elemento: elemento,
                            cantidad: cantidad,
                            monto: monto,
                            proveedor: proveedor,
                            total: cantidad * monto
                        };
                        datos.push(nuevoElemento);
                        datosImportados++;
                    }
                }

                actualizarFiltros();
                mostrarDatos();
                alert(`‚úÖ Se importaron ${datosImportados} elementos exitosamente desde Excel`);

            } catch (error) {
                console.error('Error al procesar Excel:', error);
                alert('‚ùå Error al procesar el archivo Excel. Verifica que el formato sea correcto.');
            }
        }

        // Funci√≥n para generar plantilla Excel
        function descargarPlantilla() {
            try {
                // Datos de ejemplo para la plantilla
                const datosPlantilla = [
                    ['Cargo', 'Tipo', 'Elemento', 'Cantidad', 'Monto Unitario', 'Proveedor'],
                    ['Soldador', 'EPP', 'Casco de seguridad', 2, 45.50, 'Seguridad Industrial SA'],
                    ['Soldador', 'Ropa', 'Overol ign√≠fugo', 1, 85.00, 'Textiles Industriales'],
                    ['Operario', 'EPP', 'Guantes de seguridad', 5, 12.30, 'Protecci√≥n Total'],
                    ['Supervisor', 'Ropa', 'Chaleco reflectivo', 1, 25.00, 'Uniformes Pro'],
                    ['T√©cnico', 'EPP', 'Lentes de seguridad', 3, 18.75, '√ìptica Industrial'],
                    ['Operario', 'Ropa', 'Botas de seguridad', 2, 65.00, 'Calzado Laboral']
                ];

                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(datosPlantilla);

                // Aplicar formato a los headers
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                // Estilo para headers
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: 0, c: col});
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "2C3E50" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // Cargo
                    { wch: 8 },  // Tipo
                    { wch: 25 }, // Elemento
                    { wch: 10 }, // Cantidad
                    { wch: 15 }, // Monto Unitario
                    { wch: 25 }  // Proveedor
                ];
                ws['!cols'] = colWidths;

                // Agregar hoja al workbook
                XLSX.utils.book_append_sheet(wb, ws, "Plantilla EPP");

                // Descargar archivo
                XLSX.writeFile(wb, 'plantilla_epp.xlsx');
                
                alert('‚úÖ Plantilla Excel descargada exitosamente');
                
            } catch (error) {
                console.error('Error al generar plantilla Excel:', error);
                alert('‚ùå Error al generar plantilla Excel. Descargando como CSV...');
                // Fallback a CSV
                descargarPlantillaCSV();
            }
        }

        function descargarPlantillaCSV() {
            const plantilla = [
                'Cargo,Tipo,Elemento,Cantidad,Monto Unitario,Proveedor',
                'Soldador,EPP,Casco de seguridad,2,45.50,Seguridad Industrial SA',
                'Soldador,Ropa,Overol ign√≠fugo,1,85.00,Textiles Industriales',
                'Operario,EPP,Guantes de seguridad,5,12.30,Protecci√≥n Total',
                'Supervisor,Ropa,Chaleco reflectivo,1,25.00,Uniformes Pro'
            ].join('\n');

            const blob = new Blob(['\ufeff' + plantilla], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.style.display = 'none';
            link.href = url;
            link.download = 'plantilla_epp.csv';
            
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        // Inicializar la aplicaci√≥n
        mostrarDatos();
    </script>
</body>
</html>